---
title: "Tutor Learner Database"
author: "Rupert Simpson"
output: html_notebook
---

## Establish Database:
The R code below loads the RSQLite library and establishes a connection with a locally saved database named "Tutor.db". If no such database is found in the working directory, R will create one.

The subsequent SQL statements drop any tables created during previous run sessions and create new tables for students, tutors, tutor level preferences, and schedules. These tables are then populated with example data.

```{r}
library(RSQLite)
library(glue)

dbcon <- dbConnect(RSQLite::SQLite(), "Tutor.db")
```

```{sql DropLearnersTable, connection=dbcon}
DROP TABLE IF EXISTS learners;
```

```{sql DropTutorsTable, connection=dbcon}
DROP TABLE IF EXISTS tutors;
```

```{sql DropPreferencesTable, connection=dbcon}
DROP TABLE IF EXISTS preferences;
```

```{sql DropLearnerAvailabilityTable, connection=dbcon}
DROP TABLE IF EXISTS learner_availability;
```

```{sql DropTutorAvailabilityTable, connection=dbcon}
DROP TABLE IF EXISTS tutor_availability;
```

```{sql DropUsersTable, connection=dbcon}
DROP TABLE IF EXISTS users;
```

```{sql DropMatchesTable, connection=dbcon}
DROP TABLE IF EXISTS matches;
```

```{sql CreateUsersTable, connection=dbcon}
CREATE TABLE IF NOT EXISTS users (
  user_id INTEGER PRIMARY KEY AUTOINCREMENT,
  first_name TEXT,
  last_name TEXT,
  email TEXT,
  password TEXT
);
```

```{sql CreateLearnersTable, connection=dbcon}
CREATE TABLE IF NOT EXISTS learners (
  learner_id INTEGER PRIMARY KEY AUTOINCREMENT,
  first_name TEXT,
  last_name TEXT,
  phone INT,
  email TEXT,
  level TEXT,
  conversation INT,
  available BOOL
);
```

```{sql CreateTutorsTable, connection=dbcon}
CREATE TABLE IF NOT EXISTS tutors (
  tutor_id INTEGER PRIMARY KEY AUTOINCREMENT,
  first_name TEXT,
  last_name TEXT,
  phone INT,
  email TEXT,
  available BOOL
);
```

```{sql CreateHoursTable, connection=dbcon}
CREATE TABLE IF NOT EXISTS hours (
  hours_id INTEGER PRIMARY KEY AUTOINCREMENT,
  tutor_name TEXT,
  learner_name TEXT,
  day TEXT,
  month INT,
  year INT,
  start_time TEXT,
  end_time TEXT
);
```

```{sql CreatePreferencesTable, connection=dbcon}
CREATE TABLE IF NOT EXISTS preferences (
  preference_id INTEGER PRIMARY KEY AUTOINCREMENT,
  tutor_id INT,
  conversation BOOL,
  esl_novice BOOL,
  esl_beginner BOOL,
  esl_intermediate BOOL,
  citizenship BOOL,
  sped_ela BOOL,
  basic_math BOOL,
  basic_reading BOOL,
  basic_writing BOOL,
  FOREIGN KEY (tutor_id) REFERENCES tutors(tutor_id) ON DELETE CASCADE
);
```

```{sql CreateLearnerAvailabilityTable, connection=dbcon}
CREATE TABLE IF NOT EXISTS learner_availability (
  learner_availability_id INTEGER PRIMARY KEY AUTOINCREMENT,
  learner_id INT,
  day TEXT,
  start_time TIME,
  end_time TIME,
  FOREIGN KEY (learner_id) REFERENCES learners(learner_id) ON DELETE CASCADE
);
```

```{sql CreateTutorAvailabilityTable, connection=dbcon}
CREATE TABLE IF NOT EXISTS tutor_availability (
  tutor_availability_id INTEGER PRIMARY KEY AUTOINCREMENT,
  tutor_id INT,
  day TEXT,
  start_time TIME,
  end_time TIME,
  FOREIGN KEY (tutor_id) REFERENCES tutors(tutor_id) ON DELETE CASCADE
);
```

```{sql CreateMatchesTable, connection=dbcon}
CREATE TABLE IF NOT EXISTS matches (
  match_id INTEGER PRIMARY KEY AUTOINCREMENT,
  tutor_id INT,
  learner_id INT,
  FOREIGN KEY (tutor_id) REFERENCES tutors(tutor_id) ON DELETE CASCADE,
  FOREIGN KEY (learner_id) REFERENCES tutors(learner_id) ON DELETE CASCADE
);
```

## Populate Database Tables

```{sql UsersTableInsert, connection=dbcon}
INSERT INTO users (first_name, last_name, email, password)
VALUES
  ('Rupert', 'Simpson', 'rupertsimpson@plymouthliteracy.org', 'RSblue!@#'),
  ('Karen', 'Gale', 'karengale@plymouthliteracy.org', 'RSblue!@#'),
  ('Kristen', 'Enos', 'kristenenos@plymouthliteracy.org', 'KEblue!@#');
```

```{sql LearnersTableInsert, connection=dbcon}
INSERT INTO learners (first_name, last_name, phone, email, level, conversation, available)
VALUES
  ('Sally', 'Shoo', 1111111111, 'email1@email.com', 'esl_novice', 1, false),
  ('Danny', 'Dogg', 2222222222, 'email2@email.com', 'esl_beginner', 2, false),
  ('Eddy', 'Everett', 3333333333, 'email3@email.com', 'esl_intermediate', 3, false),
  ('Patty', 'Patricks', 4444444444, 'email4@email.com', 'citizenship', 4, false),
  ('Thomas', 'Thompson', 5555555555, 'email5@email.com', 'sped_ela', 1, false),
  ('Wendy', 'Wilburg', 6666666666, 'email6@email.com', 'basic_math', 2, true),
  ('Freddy', 'Franks', 7777777777, 'email7@email.com', 'basic_math', 3, true),
  ('Bobby', 'Brown', 8888888888, 'email8@email.com', 'basic_reading', 4, true),
  ('Vinny', 'Vaughn', 9999999999, 'email9@email.com', 'basic_reading', 1, true),
  ('Mathew', 'Matters', 1010101010, 'email10@email.com', 'basic_writing', 2, true);
```

```{sql TutorsTableInsert, connection=dbcon}
INSERT INTO tutors (first_name, last_name, phone, email, available)
VALUES
  ('Quinny', 'Quigly', 1111111111, 'email11@email.com', false),
  ('Wally', 'Walter', 2222222222, 'email12@email.com', false),
  ('Earl', 'Evans', 3333333333, 'email13@email.com', false),
  ('Ruby', 'Rogers', 4444444444, 'email14@email.com', false),
  ('Timmy', 'Timber', 5555555555, 'email15@email.com', false),
  ('Owen', 'Orwell', 6666666666, 'email16@email.com', true),
  ('Ashely', 'Adams', 7777777777, 'email17@email.com', false),
  ('Sophie', 'Summers', 8888888888, 'email18@email.com', true),
  ('David', 'Demont', 9999999999, 'email19@email.com', true),
  ('Jill', 'James', 1010101010, 'email20@email.com', true);
```

```{sql PreferencesTableInsert, connection=dbcon}
INSERT INTO preferences (tutor_id, conversation, esl_novice, esl_beginner, esl_intermediate, citizenship, sped_ela, basic_math, basic_reading, basic_writing)
VALUES
  (1, false, true, true, false, false, true, false, true, true),
  (2, false, true, false, false, false, false, true, true, false),
  (3, true, false, false, true, true, true, false, false, false),
  (4, false, true, false, false, false, false, true, true, false),
  (5, true, false, false, true, true, true, false, false, false),
  (6, false, true, false, false, false, false, true, true, false),
  (7, true, false, false, true, true, false, false, false, false),
  (8, false, true, false, false, false, false, true, true, false),
  (9, true, false, false, true, true, true, false, false, false),
  (10, false, true, false, false, false, false, true, true, true);
```

```{sql LearnerAvailabilityTableInsert, connection=dbcon}
INSERT INTO learner_availability (learner_id, day, start_time, end_time)
VALUES
  (1, 'Monday', '10:00', '20:00'),
  (1, 'Tuesday', '12:00', '20:00'),
  (1, 'Wednesday', '11:00', '20:00'),
  (2, 'Thursday', '12:00', '17:00'),
  (2, 'Friday', '10:00', '17:00'),
  (2, 'Monday', '19:00', '21:00'),
  (3, 'Tuesday', '10:00', '20:00'),
  (3, 'Wednesday', '10:00', '15:00'),
  (3, 'Friday', '16:00', '20:00'),
  (4, 'Thursday', '10:00', '17:00'),
  (4, 'Monday', '12:00', '17:00'),
  (4, 'Tuesday', '10:00', '17:00'),
  (5, 'Monday', '10:00', '20:00'),
  (5, 'Friday', '10:00', '17:00'),
  (5, 'Tuesday', '11:00', '17:00'),
  (6, 'Tuesday', '10:00', '17:00'),
  (6, 'Wednesday', '10:00', '17:00'),
  (6, 'Thursday', '10:00', '17:00'),
  (7, 'Friday', '12:00', '17:00'),
  (7, 'Wednesday', '15:00', '17:00'),
  (7, 'Monday', '10:00', '17:00'),
  (8, 'Monday', '12:00', '14:00'),
  (8, 'Tuesday', '10:00', '12:00'),
  (8, 'Wednesday', '10:00', '12:00'),
  (9, 'Monday', '17:00', '19:00'),
  (9, 'Wednesday', '10:00', '19:00'),
  (9, 'Friday', '11:00', '19:00'),
  (10, 'Monday', '10:00', '14:00'),
  (10, 'Tuesday', '10:00', '12:00'),
  (10, 'Wednesday', '10:00', '20:00');
```

```{sql TutorAvailabilityTableInsert, connection=dbcon}
INSERT INTO tutor_availability (tutor_id, day, start_time, end_time)
VALUES
  (1, 'Tuesday', '10:00', '17:00'),
  (1, 'Wednesday', '11:00', '20:00'),
  (1, 'Thursday', '12:00', '17:00'),
  (2, 'Monday', '12:00', '17:00'),
  (2, 'Wednesday', '10:00', '17:00'),
  (2, 'Friday', '10:00', '17:00'),
  (3, 'Monday', '10:00', '20:00'),
  (3, 'Thursday', '10:00', '15:00'),
  (3, 'Friday', '16:00', '20:00'),
  (4, 'Monday', '12:00', '17:00'),
  (4, 'Tuesday', '10:00', '17:00'),
  (4, 'Wednesday', '10:00', '17:00'),
  (5, 'Tuesday', '11:00', '17:00'),
  (5, 'Thursday', '10:00', '20:00'),
  (5, 'Friday', '10:00', '17:00'),
  (6, 'Monday', '10:00', '17:00'),
  (6, 'Wednesday', '10:00', '17:00'),
  (6, 'Thursday', '10:00', '17:00'),
  (7, 'Monday', '10:00', '17:00'),
  (7, 'Wednesday', '15:00', '17:00'),
  (7, 'Friday', '12:00', '17:00'),
  (8, 'Tuesday', '10:00', '12:00'),
  (8, 'Thursday', '12:00', '14:00'),
  (8, 'Friday', '10:00', '12:00'),
  (9, 'Monday', '17:00', '19:00'),
  (9, 'Thursday', '10:00', '19:00'),
  (9, 'Friday', '11:00', '19:00'),
  (10, 'Monday', '10:00', '14:00'),
  (10, 'Tuesday', '10:00', '12:00'),
  (10, 'Wednesday', '10:00', '20:00');
```

```{sql MatchesTableInsert, connection=dbcon}
INSERT INTO matches (tutor_id, learner_id)
VALUES
  (1, 1),
  (2, 2),
  (3, 3),
  (4, 4),
  (5, 5);
```

## Queries

```{sql QueryLearnersTable, connection=dbcon}
SELECT first_name, substr(last_name, 1, 1) AS last_initial FROM learners;
```

```{sql QueryTutorsTable, connection=dbcon}
SELECT first_name, substr(last_name, 1, 1) AS last_initial FROM tutors;
```

```{sql QueryAvailableTutors, connection=dbcon}
SELECT first_name first_name, substr(last_name, 1, 1) AS last_initial FROM tutors
WHERE available;
```

```{sql QueryForEmails, connection=dbcon}
SELECT email FROM learners
UNION
SELECT email FROM tutors;
```

### Find Students for Quinn

```{r FindLearnersForQuinn, connection=dbcon}
# Quinn's ID.
tutor_id <- '1';

# Query to find tutor schedule.
tutor_schedule <- dbGetQuery(dbcon, glue("SELECT day, start_time, end_time FROM tutor_availability WHERE tutor_id = {tutor_id};"))

# Query to find tutor preferences.
tutor_preferences <- dbGetQuery(dbcon, glue("SELECT conversation, esl_novice, esl_beginner, esl_intermediate, citizenship, sped_ela, basic_math, basic_reading, basic_writing FROM preferences WHERE tutor_id = {tutor_id};"))

days <- tutor_schedule$day
start_times <- tutor_schedule$start_time
end_times <- tutor_schedule$end_time

# List of preferences.
preference_names <- c("conversation", "esl_novice", "esl_beginner", "esl_intermediate", "citizenship", "sped_ela", "basic_math", "basic_reading", "basic_writing")

# Create empty preference string.
preference_query_string <- "";

for (i in 1:length(preference_names)) {
  if (tutor_preferences[i] == '1') {
    preference_query_string <- glue("{preference_query_string}, '{preference_names[i]}'")
  }
}
preference_query_string <- substr(preference_query_string, 3, nchar(preference_query_string))

# Create dataframe to save matches.
matches <- data.frame(first_name = character(),
                      last_initial = character(),
                      level = character(),
                      day = character(),
                      start_time = character(),
                      end_time = character())

for (i in 1:length(days)) {
  match_query <- (glue("SELECT
      l.first_name, substr(l.last_name, 1, 1) AS last_name, l.level, la.day, la.start_time, la.end_time
  FROM
      learners l
  JOIN
      learner_availability la ON l.learner_id = la.learner_id
  WHERE
      l.available AND
      l.level IN ({preference_query_string}) AND
      la.day = '{days[i]}' AND
      la.start_time < '{end_times[i]}' AND
      la.end_time > '{start_times[i]}';"))
  
  result <- dbGetQuery(dbcon, match_query)

  matches <- rbind(matches, result)
}

print(matches)
```

### Find Matches

```{r FindLearnersForWally, connection=dbcon}
# Wally's ID.
tutor_id <- '2';

# Query to find tutor schedule.
tutor_schedule <- dbGetQuery(dbcon, glue("SELECT day, start_time, end_time FROM tutor_availability WHERE tutor_id = {tutor_id};"))

# Query to find tutor preferences.
tutor_preferences <- dbGetQuery(dbcon, glue("SELECT conversation, esl_novice, esl_beginner, esl_intermediate, citizenship, sped_ela, basic_math, basic_reading, basic_writing FROM preferences WHERE tutor_id = {tutor_id};"))

days <- tutor_schedule$day
start_times <- tutor_schedule$start_time
end_times <- tutor_schedule$end_time

# List of preferences.
preference_names <- c("conversation", "esl_novice", "esl_beginner", "esl_intermediate", "citizenship", "sped_ela", "basic_math", "basic_reading", "basic_writing")

# Create empty preference string.
preference_query_string <- "";

for (i in 1:length(preference_names)) {
  if (tutor_preferences[i] == '1') {
    preference_query_string <- glue("{preference_query_string}, '{preference_names[i]}'")
  }
}
preference_query_string <- substr(preference_query_string, 3, nchar(preference_query_string))

# Create dataframe to save matches.
matches <- data.frame(first_name = character(),
                      last_initial = character(),
                      level = character(),
                      day = character(),
                      start_time = character(),
                      end_time = character())

for (i in 1:length(days)) {
  match_query <- (glue("SELECT
      l.first_name, substr(l.last_name, 1, 1) AS last_name, l.level, la.day, la.start_time, la.end_time
  FROM
      learners l
  JOIN
      learner_availability la ON l.learner_id = la.learner_id
  WHERE
      l.available AND
      l.level IN ({preference_query_string}) AND
      la.day = '{days[i]}' AND
      la.start_time < '{end_times[i]}' AND
      la.end_time > '{start_times[i]}';"))
  
  result <- dbGetQuery(dbcon, match_query)

  matches <- rbind(matches, result)
}

print(matches)
```

```{r FindStudentsForEarl, connection=dbcon}
# Earl's ID.
tutor_id <- '3';

# Query to find tutor schedule.
tutor_schedule <- dbGetQuery(dbcon, glue("SELECT day, start_time, end_time FROM tutor_availability WHERE tutor_id = {tutor_id};"))

# Query to find tutor preferences.
tutor_preferences <- dbGetQuery(dbcon, glue("SELECT conversation, esl_novice, esl_beginner, esl_intermediate, citizenship, sped_ela, basic_math, basic_reading, basic_writing FROM preferences WHERE tutor_id = {tutor_id};"))

days <- tutor_schedule$day
start_times <- tutor_schedule$start_time
end_times <- tutor_schedule$end_time

# List of preferences.
preference_names <- c("conversation", "esl_novice", "esl_beginner", "esl_intermediate", "citizenship", "sped_ela", "basic_math", "basic_reading", "basic_writing")

# Create empty preference string.
preference_query_string <- "";

for (i in 1:length(preference_names)) {
  if (tutor_preferences[i] == '1') {
    preference_query_string <- glue("{preference_query_string}, '{preference_names[i]}'")
  }
}
preference_query_string <- substr(preference_query_string, 3, nchar(preference_query_string))

# Create dataframe to save matches.
matches <- data.frame(first_name = character(),
                      last_initial = character(),
                      level = character(),
                      day = character(),
                      start_time = character(),
                      end_time = character())

for (i in 1:length(days)) {
  match_query <- (glue("SELECT
      l.first_name, substr(l.last_name, 1, 1) AS last_name, l.level, la.day, la.start_time, la.end_time
  FROM
      learners l
  JOIN
      learner_availability la ON l.learner_id = la.learner_id
  WHERE
      l.available AND
      l.level IN ({preference_query_string}) AND
      la.day = '{days[i]}' AND
      la.start_time < '{end_times[i]}' AND
      la.end_time > '{start_times[i]}';"))
  
  result <- dbGetQuery(dbcon, match_query)

  matches <- rbind(matches, result)
}

print(matches)
```

```{r}
dbDisconnect(dbcon)
```